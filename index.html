<!-- <!DOCTYPE html> -->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ASCII JPEG</title>
<style>
  /* Dark mode styles */
  body {
    background-color: #121212;
    color: #e0e0e0;
    font-family: monospace;
  }

  /* Hide the radio buttons */
  input[type="radio"] {
    display: none;
  }

  /* Container for columns */
  .container {
    display: flex;
    align-items: flex-start;
  }

  /* JPEG column */
  .jpeg-column {
    flex: 1;
  }

  /* ASCII column */
  .ascii-column {
    flex: 1;
    margin-left: 20px;
    margin-right: 20px;
    display: flex;
    flex-direction: column;
  }

  /* Right column */
  .right-column {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Style the labels to look like buttons */
  label.option-xabel {
    display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    margin: 10px;
    border: 2px solid #bb86fc;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
    color: #e0e0e0;
  }

  /* Change background on hover */
  label.option-xabel:hover {
    background-color: #1f1f1f;
  }

  /* Style the selected label */
  input[type="radio"]:checked + label.option-xabel {
    background-color: #bb86fc;
    color: #000000;
  }


  /* Style the labels to look like buttons */
  label.option-label {
    display: inline-block;
    padding: 6px 10px;
    margin: 5px;
    border: 2px solid #bb86fc;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
    color: #e0e0e0;
  }

  /* Change background on hover */
  label.option-label:hover {
    background-color: #1f1f1f;
  }

  /* Style the selected label */
  input[type="radio"]:checked + label.option-label {
    background-color: #bb86fc;
    color: #000000;
  }

  /* Component styles */
  .component {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #333333;
    border-radius: 4px;
    background-color: #1e1e1e;
  }

  .component.disabled {
    opacity: 0.5;
  }

  .component-title {
    font-weight: bold;
    margin-bottom: 10px;
    color: #bb86fc;
  }

  /* Table styles for components */
  .component table {
    width: 100%;
    border-collapse: collapse;
  }

  .component th, .component td {
    padding: 5px;
    text-align: center;
  }

  .component th {
    font-weight: bold;
    color: #bb86fc;
  }

  .component select {
    width: 60px;
    background-color: #2e2e2e;
    color: #e0e0e0;
    border: 1px solid #555555;
    border-radius: 4px;
    padding: 2px;
  }

  /* Textarea in the middle column */
  .ascii-column textarea {
    flex: 1;
    resize: none;
    background-color: #1e1e1e;
    color: #e0e0e0;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 10px;
  }

  /* Heading above the textarea */
  .ascii-column h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #bb86fc;
    text-align: center;
  }

  /* Status line */
  #status {
    margin-top: 20px;
    font-weight: bold;
    color: #cf6679;
  }

  /* Ensure columns stretch equally */
  .jpeg-column, .ascii-column, .right-column {
    align-self: stretch;
  }

  /* Right column styling */
  .right-column {
    display: flex;
    flex-direction: column;
  }

  .image-row {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center; /* Center contents horizontally */
    margin-bottom: 20px;
    background-color: #1e1e1e;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 10px;
  }

  .image-row:last-child {
    margin-bottom: 0;
  }

  .image-row h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #bb86fc;
    text-align: center;
    display: inline-block;
  }

  .image-row img {
    flex: 1;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block; /* Ensure image is block-level */
    margin: 0 auto; /* Center image horizontally */
  }

  /* Set specific size for the ASCII JPEG */
  #jpeg-div {
    width: 128px;
    height: 128px;
    display: flex;
    align-items: center;
  }

  /* Set specific size for the Instagrammable image */
  #png {
    width: 512px;
    height: 512px;
    margin: 0 auto;
  }

  .image-row .button-container {
    text-align: center;
    margin-top: 10px;
  }

  .image-row button {
    padding: 10px 20px;
    background-color: #bb86fc;
    color: #000000;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .image-row button:hover {
    background-color: #a675e1;
  }

</style>
</head>
<body>

<div class="container">
  <!-- JPEG column -->
  <div class="jpeg-column">
    <div id="image-sizes">
    </div>

    <!-- Radio buttons and labels -->
    <input type="radio" id="grayscale" name="color_mode">
    <label class="option-label" for="grayscale">Grayscale</label>

    <input type="radio" id="yuv444" name="color_mode" checked>
    <label class="option-label" for="yuv444">YUV444</label>

    <input type="radio" id="yuv422" name="color_mode">
    <label class="option-label" for="yuv422">YUV422</label>

    <input type="radio" id="yuv420" name="color_mode">
    <label class="option-label" for="yuv420">YUV420</label>

    <!-- Components -->
    <div id="components">
      <!-- Component 1 -->
      <div class="component" id="component1">
        <div class="component-title">Component #1</div>
        <table>
          <tr>
            <th></th>
            <th>DC</th>
            <th>AC</th>
          </tr>
          <tr>
            <td>Quantization:</td>
            <td>
<!--
              <select name="quant_dc_1">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_dc_1" type="range" value="1" min="1" max="255">
            </td>
            <td>
<!--
              <select name="quant_ac_1">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_ac_1" type="range" value="4" min="1" max="255">
            </td>
          </tr>
          <tr>
            <td>Huffman:</td>
            <td>
              <select name="huff_dc_1">
                <option value="0" selected>skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8">full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
            <td>
              <select name="huff_ac_1">
                <option value="0">skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8" selected>full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
          </tr>
        </table>
      </div>

      <!-- Component 2 -->
      <div class="component" id="component2">
        <div class="component-title">Component #2</div>
        <table>
          <tr>
            <th></th>
            <th>DC</th>
            <th>AC</th>
          </tr>
          <tr>
            <td>Quantization:</td>
            <td>
<!--
              <select name="quant_dc_2">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_dc_2" type="range" value="1" min="1" max="255">
            </td>
            <td>
<!--
              <select name="quant_ac_2">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_ac_2" type="range" value="4" min="1" max="255">
            </td>
          </tr>
          <tr>
            <td>Huffman:</td>
            <td>
              <select name="huff_dc_2">
                <option value="0" selected>skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8">full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
            <td>
              <select name="huff_ac_2">
                <option value="0">skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8" selected>full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
          </tr>
        </table>
      </div>

      <!-- Component 3 -->
      <div class="component" id="component3">
        <div class="component-title">Component #3</div>
        <table>
          <tr>
            <th></th>
            <th>DC</th>
            <th>AC</th>
          </tr>
          <tr>
            <td>Quantization:</td>
            <td>
<!--
              <select name="quant_dc_3">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_dc_3" type="range" value="1" min="1" max="255">
            </td>
            <td>
<!--
              <select name="quant_ac_3">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="255">255</option>
              </select>
-->
<input name="quant_ac_3" type="range" value="4" min="1" max="255">
            </td>
          </tr>
          <tr>
            <td>Huffman:</td>
            <td>
              <select name="huff_dc_3">
                <option value="0" selected>skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8">full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
            <td>
              <select name="huff_ac_3">
                <option value="0">skip</option>
                <option value="1">1 bit</option>
                <option value="2">2 bits</option>
                <option value="3">3 bits</option>
                <option value="4">4 bits</option>
                <option value="5">5 bits</option>
                <option value="6">6 bits</option>
                <option value="7">7 bits</option>
                <option value="8" selected>full range</option>
                <option value="9">2 bytes</option>
                <option value="10">min4</option>
              </select>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- ASCII column -->
  <div class="ascii-column">
    <div class="header-row">
      <h3>ASCII</h3>
    </div>
    <textarea id="textbox"></textarea>
  </div>

  <!-- Right column -->
  <div class="right-column">
    <!-- First row -->
    <div class="image-row">
      <h3>ASCII JPEG</h3>
      <div id="jpeg-div">
        <img id="jpeg" src="" alt="JPEG Image">
      </div>
      <div class="button-container">
        <button id="download-jpeg">Download real ASCII JPEG</button>
      </div>
    </div>

    <!-- Second row -->
    <div class="image-row">
      <h3>Instagrammable image</h3>
      <img id="png" src="" alt="Instagrammable Image">
      <div class="button-container">
        <button id="download-png">Download Instagrammable image</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Line -->
<div id="status"></div>

<!-- Include ascii_jpeg.js -->
<script src="ascii_jpeg.js"></script>

<script>
  // Helper function to generate options from min to max with selected value
  function generateOptions(min, max, selectedValue) {
    let options = '';
    for (let i = min; i <= max; i++) {
      options += `<option value="${i}"${i === selectedValue ? ' selected' : ''}>${i}</option>`;
    }
    return options;
  }

  // JavaScript to enable/disable components and handle updates
  document.addEventListener('DOMContentLoaded', function() {

    // Create image sizes table
    const div_image_sizes = document.getElementById("image-sizes");
    const image_size_widths = [ 8, 16, 32, 64, 128 ];
    const image_size_heights = [ 8, 16, 32, 64, 128 ];
    const image_size_table = document.createElement("table");
    for ( width of image_size_widths )
    {
      const tr = document.createElement("tr");
      for ( height of image_size_heights )
      {
        const td = document.createElement("td");
        {
          const name = `${width}x${height}`;

          const input = document.createElement("input");
          input.type = "radio";
          input.id   = `size${name}`;
          input.name = "image_size";
          input.addEventListener("change", update);
          if ( width == 16 )
            input.checked = true;
          td.appendChild(input);

          const label = document.createElement("label");
          label.className = "option-xabel";
          label.htmlFor   = `size${name}`;
          label.innerText = name;
          td.appendChild(label);
        }
        image_size_table.appendChild(td);
      }
      image_size_table.appendChild(tr);
    }
    div_image_sizes.appendChild(image_size_table);

    const colorModes = document.querySelectorAll('input[name="color_mode"]');
    const components = {
      1: document.getElementById('component1'),
      2: document.getElementById('component2'),
      3: document.getElementById('component3')
    };
    const statusLine = document.getElementById('status');
    const textarea = document.getElementById('textbox');
    const jpegImage = document.getElementById('jpeg');
    const pngImage = document.getElementById('png');

    // Set default ASCII content after ascii_jpeg.js is loaded
    textarea.value = default_ascii;

    function updateComponents() {
      const selectedMode = document.querySelector('input[name="color_mode"]:checked').id;
      if (selectedMode === 'grayscale') {
        enableComponent(1);
        disableComponent(2);
        disableComponent(3);
      } else {
        enableComponent(1);
        enableComponent(2);
        enableComponent(3);
      }
      update(); // Call update() after components have been updated
    }

    function enableComponent(num) {
      components[num].classList.remove('disabled');
      components[num].querySelectorAll('select').forEach(el => {
        el.disabled = false;
      });
    }

    function disableComponent(num) {
      components[num].classList.add('disabled');
      components[num].querySelectorAll('select').forEach(el => {
        el.disabled = true;
      });
    }

    // Attach event listeners to color mode radio buttons
    colorModes.forEach(radio => {
      radio.addEventListener('change', updateComponents);
    });

    // Attach event listeners to Quantization selects
    document.querySelectorAll('input[name^="quant_dc_"], input[name^="quant_ac_"]').forEach(select => {
      select.addEventListener('change', update);
    });

    // Attach event listeners to Huffman selects
    document.querySelectorAll('select[name^="huff_dc_"], select[name^="huff_ac_"]').forEach(select => {
      select.addEventListener('change', update);
    });

    // Attach event listener to textarea with debounce
    let updateTimeout;
    textarea.addEventListener('input', function() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(update, 200);
    });

    function getImageSize() {
      const selectedSizeRadio = document.querySelector('input[name="image_size"]:checked');
      if (selectedSizeRadio) {
        const sizeValue = selectedSizeRadio.id.replace('size', '');
        return parseInt(sizeValue);
      }
      console.log("not checked");
      return 64; // default size
    }

    // The update function
    function update() {
      // Clear status line
      statusLine.textContent = '';

      // Get colorspace
      const colorspace = document.querySelector('input[name="color_mode"]:checked + label').textContent;

      // Get image size
      const imageSize = getImageSize();

      // Initialize components array
      const componentsArray = [];

      // Get values from enabled components
      const enabledComponents = document.querySelectorAll('.component:not(.disabled)');
      for (const component of enabledComponents) {
        const quant_dc_select = component.querySelector('input[name^="quant_dc_"]');
        const quant_ac_select = component.querySelector('input[name^="quant_ac_"]');
        const huff_dc_select = component.querySelector('select[name^="huff_dc_"]');
        const huff_ac_select = component.querySelector('select[name^="huff_ac_"]');

        const quant_dc = parseInt(quant_dc_select.value);
        const quant_ac = parseInt(quant_ac_select.value);
        const huff_dc = parseInt(huff_dc_select.value);
        const huff_ac = parseInt(huff_ac_select.value);

        // Add component values as a subarray
        componentsArray.push([quant_dc, quant_ac, huff_dc, huff_ac]);
      }

      // Get ASCII content from textarea
      const ascii = textarea.value;

      // Check that the textbox content only has printable ASCII characters and whitespace
      const asciiRegex = /^[\x20-\x7E\r\n\t]*$/;
      if (!asciiRegex.test(ascii)) {
        statusLine.textContent = 'Error: Textbox content must contain only printable ASCII characters.';
        return;
      }

      // Call ascii_jpeg() with the parameters
      ascii_jpeg(colorspace, componentsArray, ascii, imageSize, imageSize);

      // Update the image dimensions
      jpegImage.width = imageSize;
      jpegImage.height = imageSize;
    }

    // Handle Download JPEG button
    const downloadJpegButton = document.getElementById('download-jpeg');

    downloadJpegButton.addEventListener('click', function() {
      if (window.jpeg_blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(window.jpeg_blob);
        link.download = 'ascii.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        statusLine.textContent = 'Error: No JPEG data available to download.';
      }
    });

    // Handle Download Instagrammable image button
    const downloadPngButton = document.getElementById('download-png');

    downloadPngButton.addEventListener('click', function() {
      if (window.png_blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(window.png_blob);
        link.download = 'ascii_instagram.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        statusLine.textContent = 'Error: No PNG data available to download.';
      }
    });

    // Initial update
    updateComponents();
  });
</script>

</body>
</html>
