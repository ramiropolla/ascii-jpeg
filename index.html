<!-- <!DOCTYPE html> -->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ascii.jpeg</title>
<style>
  /* Dark mode styles */
  body {
    background-color: #121212;
    color: #e0e0e0;
    font-family: monospace;
  }

  /* Container */
  .container {
    display: flex;
    align-items: flex-start;
  }

  .box {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #333333;
    border-radius: 4px;
    background-color: #1e1e1e;
  }

  .box span {
    font-weight: bold;
    color: #bb86fc;
  }

  .box:last-child {
    margin-bottom: 0;
  }


  /*** TITLES ***/
  .title {
    background-color: #1e1e1e;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
  }

  .title h3 {
    margin-top: 0;
    margin-bottom: 0;
    color: #bb86fc;
  }


  /*** HEADERS ***/
  .col_headers {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Hide the radio buttons */
  .col_headers input[type="radio"] {
    display: none;
  }


  /*** ASCII ***/
  .col_ascii {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-left: 20px;
    margin-right: 20px;
  }

  /* Output column */
  .col_output {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Style the labels to look like buttons */
  label.option-label {
    display: inline-block;
    padding: 10px 10px;
    margin: 5px;
    border: 2px solid #bb86fc;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
    color: #e0e0e0;
  }

  /* Change background on hover */
  label.option-label:hover {
    background-color: #2f2f2f;
  }

  /* Style the selected label */
  input[type="radio"]:checked + label.option-label {
    background-color: #bb86fc;
    color: #000000;
  }

  /* Component styles */
  .component {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #333333;
    border-radius: 4px;
    background-color: #1e1e1e;
  }

  .component.disabled {
    opacity: 0.5;
  }

  .component table {
    width: 100%;
    border-collapse: collapse;
  }

  .component th, .component td {
    padding: 5px;
    text-align: center;
  }

  .component th {
    font-weight: bold;
    color: #bb86fc;
  }

  .component select {
    width: 60px;
    background-color: #2e2e2e;
    color: #e0e0e0;
    border: 1px solid #555555;
    border-radius: 4px;
    padding: 2px;
  }

  /* Textarea in the middle column */
  .col_ascii textarea {
    flex: 1;
    background-color: #1e1e1e;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 10px;
    resize: none;
    color: #e0e0e0;
  }

  /* Status line */
  #status {
    margin-top: 20px;
    font-weight: bold;
    color: #cf6679;
  }

  /* Ensure columns stretch equally */
  .col_headers, .col_ascii, .col_output {
    align-self: stretch;
  }

  /* Output column styling */
  .col_output {
    display: flex;
    flex-direction: column;
  }

  .image-row {
    flex: 1;
    background-color: #1e1e1e;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
  }

  .image-row:last-child {
    margin-bottom: 0;
  }

  .image-row img {
    flex: 1;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block; /* Ensure image is block-level */
    margin: 0 auto; /* Center image horizontally */
  }

  #jpeg-div {
    width: 128px;
    height: 128px;
    display: flex;
    align-items: center;
  }

  #png {
    width: 512px;
    height: 512px;
    margin: 0 auto;
  }

  .image-row .button-container {
    text-align: center;
    margin-top: 10px;
  }

  .image-row button {
    padding: 10px 20px;
    background-color: #bb86fc;
    color: #000000;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .image-row button:hover {
    background-color: #a675e1;
  }

</style>
</head>
<body>

<div class="container">
  <!-- Headers -->
  <div class="col_headers">
    <div class="title">
      <h3>headers</h3>
    </div>

    <!-- Image Sizes -->
    <div class="box" id="image-sizes">
      <span>Size:</span>
    </div>

    <!-- Pixel Formats -->
    <div class="box" id="pixel-formats">
      <div id="pixel-formats-list">
        <span>Pixel format:</span>
      </div>
      <div id="components"></div>
    </div>
  </div>

  <!-- ASCII -->
  <div class="col_ascii">
    <div class="title">
      <h3>ascii</h3>
    </div>

    <!-- ascii text -->
    <textarea id="textbox"></textarea>
  </div>

  <!-- Output -->
  <div class="col_output">
    <div class="title">
      <h3>ascii.jpeg</h3>
    </div>

    <!-- ascii.jpeg -->
    <div class="image-row">
      <div id="jpeg-div">
        <img id="jpeg" src="" alt="ascii.jpeg">
      </div>
      <div class="button-container">
        <button id="download-jpeg">Download ascii.jpeg</button>
      </div>
    </div>

    <!-- baked.png -->
    <div class="image-row">
      <img id="png" src="" alt="baked.png">
      <div class="button-container">
        <button id="download-png">Download baked.png</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Line -->
<div id="status"></div>

<!-- Include ascii_jpeg.js -->
<script src="ascii_jpeg.js"></script>

<script>
  /* Helper function to generate options from min to max with selected value */
  function generateOptions(min, max, selectedValue) {
    let options = '';
    for (let i = min; i <= max; i++) {
      options += `<option value="${i}"${i === selectedValue ? ' selected' : ''}>${i}</option>`;
    }
    return options;
  }

  /* JavaScript to enable/disable components and handle updates */
  document.addEventListener('DOMContentLoaded', function() {
    /* Image Sizes */
    const div_image_sizes = document.getElementById("image-sizes");
    const image_size_values = [ 8, 16, 32, 64, 128 ];
    const default_image_size = 16;
    for ( value of image_size_values )
    {
      const name = `${value}x${value}`;
      const id = `size${name}`;

      const input = document.createElement("input");
      input.type = "radio";
      input.id   = id;
      input.name = "image_size";
      input.addEventListener("change", update);
      if ( value == default_image_size )
        input.checked = true;
      div_image_sizes.appendChild(input);

      const label = document.createElement("label");
      label.className = "option-label";
      label.htmlFor   = id;
      label.innerText = name;
      div_image_sizes.appendChild(label);
    }

    /* Pixel Formats */
    const div_pixel_formats_list = document.getElementById("pixel-formats-list");
    const color_mode_values = [
      "Grayscale",
      "YUV444",
      "YUV422",
      "YUV420",
    ];
    const default_color_mode = "YUV444";
    for ( const value of color_mode_values )
    {
      const name = value;
      const id = name.toLowerCase();

      const input = document.createElement("input");
      input.type = "radio";
      input.id   = id;
      input.name = "color_mode";
      input.addEventListener("change", updateComponents);
      if ( value == default_color_mode )
        input.checked = true;
      div_pixel_formats_list.appendChild(input);

      const label = document.createElement("label");
      label.className = "option-label";
      label.htmlFor   = id;
      label.innerText = name;
      div_pixel_formats_list.appendChild(label);
    }

    /* Components */
    const div_components = document.getElementById("components");
    let components = [];
    for ( let i = 0; i < 3; i++ )
    {
      const id = `component${i + 1}`;

      const component = document.createElement("div");
//      component.classList.add("box", "component");
      component.className = "component";
      component.id        = id;
      components.push(component);
      div_components.appendChild(component);

      const table = document.createElement("table");

      /* Labels */
      let th, td, input, select, option;
      {
        const tr = document.createElement("tr");
        th = document.createElement("th");
        th.innerText = `Component #${i + 1}`;
        tr.appendChild(th);
        th = document.createElement("th");
        th.innerText = "DC";
        tr.appendChild(th);
        th = document.createElement("th");
        th.innerText = "AC";
        tr.appendChild(th);
        table.appendChild(tr);
      }

      /* Quantization */
      {
        const tr = document.createElement("tr");
        td = document.createElement("td");
        td.innerText = "Quantization:";
        tr.appendChild(td);
        td = document.createElement("td");
        input = document.createElement("input");
        input.name = `quant_dc_${i + 1}`;
        input.type = "range";
        input.value = 1;
        input.min = 1;
        input.max = 255;
        td.appendChild(input);
        tr.appendChild(td);
        td = document.createElement("td");
        input = document.createElement("input");
        input.name = `quant_ac_${i + 1}`;
        input.type = "range";
        input.value = 4;
        input.min = 1;
        input.max = 255;
        td.appendChild(input);
        tr.appendChild(td);
        table.appendChild(tr);
      }

      /* Huffman */
      {
        const huff_values = [
          "skip",
          "1 bit",
          "2 bits",
          "3 bits",
          "4 bits",
          "5 bits",
          "6 bits",
          "7 bits",
          "full range",
          "2 bytes",
          "min4",
        ];

        const tr = document.createElement("tr");
        td = document.createElement("td");
        td.innerText = "Huffman:";
        tr.appendChild(td);

        td = document.createElement("td");
        select = document.createElement("select");
        select.name = `huff_dc_${i + 1}`;
        for ( const j in huff_values )
        {
          option = document.createElement("option");
          option.value = j;
          option.innerText = huff_values[j];
          if ( j == 0 )
            option.selected = true;
          select.appendChild(option);
        }
        td.appendChild(select);
        tr.appendChild(td);

        td = document.createElement("td");
        select = document.createElement("select");
        select.name = `huff_ac_${i + 1}`;
        for ( const j in huff_values )
        {
          option = document.createElement("option");
          option.value = j;
          option.innerText = huff_values[j];
          if ( j == 8 )
            option.selected = true;
          select.appendChild(option);
        }
        td.appendChild(select);
        tr.appendChild(td);

        table.appendChild(tr);
      }

      component.appendChild(table);
    }

    const statusLine = document.getElementById('status');
    const textarea = document.getElementById('textbox');
    const jpegImage = document.getElementById('jpeg');
    const pngImage = document.getElementById('png');

    /* Set default ASCII content after ascii_jpeg.js is loaded */
    textarea.value = default_ascii;

    function updateComponents() {
      const selectedMode = document.querySelector('input[name="color_mode"]:checked').id;
      if (selectedMode === 'grayscale') {
        enableComponent(1);
        disableComponent(2);
        disableComponent(3);
      } else {
        enableComponent(1);
        enableComponent(2);
        enableComponent(3);
      }
      update(); /* Call update() after components have been updated */
    }

    function enableComponent(num) {
      components[num - 1].classList.remove('disabled');
      components[num - 1].querySelectorAll('select').forEach(el => {
        el.disabled = false;
      });
    }

    function disableComponent(num) {
      components[num - 1].classList.add('disabled');
      components[num - 1].querySelectorAll('select').forEach(el => {
        el.disabled = true;
      });
    }

    /* Attach event listeners to Quantization selects */
    document.querySelectorAll('input[name^="quant_dc_"], input[name^="quant_ac_"]').forEach(select => {
      select.addEventListener('change', update);
    });

    /* Attach event listeners to Huffman selects */
    document.querySelectorAll('select[name^="huff_dc_"], select[name^="huff_ac_"]').forEach(select => {
      select.addEventListener('change', update);
    });

    /* Attach event listener to textarea with debounce */
    let updateTimeout;
    textarea.addEventListener('input', function() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(update, 200);
    });

    function getImageSize() {
      const selectedSizeRadio = document.querySelector('input[name="image_size"]:checked');
      if (selectedSizeRadio) {
        const sizeValue = selectedSizeRadio.id.replace('size', '');
        return parseInt(sizeValue);
      }
      return 64; /* default size */
    }

    /* The update function */
    function update() {
      /* Clear status line */
      statusLine.textContent = '';

      /* Get colorspace */
      const colorspace = document.querySelector('input[name="color_mode"]:checked + label').textContent;

      /* Get image size */
      const imageSize = getImageSize();

      /* Initialize components array */
      const componentsArray = [];

      /* Get values from enabled components */
      const enabledComponents = document.querySelectorAll('.component:not(.disabled)');
      for (const component of enabledComponents) {
        const quant_dc_select = component.querySelector('input[name^="quant_dc_"]');
        const quant_ac_select = component.querySelector('input[name^="quant_ac_"]');
        const huff_dc_select = component.querySelector('select[name^="huff_dc_"]');
        const huff_ac_select = component.querySelector('select[name^="huff_ac_"]');

        const quant_dc = parseInt(quant_dc_select.value);
        const quant_ac = parseInt(quant_ac_select.value);
        const huff_dc = parseInt(huff_dc_select.value);
        const huff_ac = parseInt(huff_ac_select.value);

        /* Add component values as a subarray */
        componentsArray.push([quant_dc, quant_ac, huff_dc, huff_ac]);
      }

      /* Get ASCII content from textarea */
      const ascii = textarea.value;

      /* Check that the textbox content only has printable ASCII characters and whitespace */
      const asciiRegex = /^[\x20-\x7E\r\n\t]*$/;
      if (!asciiRegex.test(ascii)) {
        statusLine.textContent = 'Error: Textbox content must contain only printable ASCII characters.';
        return;
      }

      /* Call ascii_jpeg() with the parameters */
      ascii_jpeg(colorspace, componentsArray, ascii, imageSize, imageSize);

      /* Update the image dimensions */
      jpegImage.width = imageSize;
      jpegImage.height = imageSize;
    }

    /* Handle Download JPEG button */
    const downloadJpegButton = document.getElementById('download-jpeg');

    downloadJpegButton.addEventListener('click', function() {
      if (window.jpeg_blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(window.jpeg_blob);
        link.download = 'ascii.jpeg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        statusLine.textContent = 'Error: No JPEG data available to download.';
      }
    });

    /* Handle Download Baked image button */
    const downloadPngButton = document.getElementById('download-png');

    downloadPngButton.addEventListener('click', function() {
      if (window.png_blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(window.png_blob);
        link.download = 'ascii_baked.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        statusLine.textContent = 'Error: No PNG data available to download.';
      }
    });

    /* Initial update */
    updateComponents();
  });
</script>

</body>
</html>
